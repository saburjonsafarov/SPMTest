name: ðŸ“¦ Build & Publish XCFramework + Update Package.swift

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build_publish:
    runs-on: macos-latest

    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v3

      - name: ðŸ›  Resolve SwiftPM Dependencies
        run: swift package resolve

      - name: ðŸ§° Build XCFramework
        uses: unsignedapps/swift-create-xcframework@v2

      - name: ðŸ“¦ Package ZIP
        run: |
          FRAMEWORK=$(ls *.xcframework)
          mv "$FRAMEWORK" SPMTest.xcframework
          zip -r "SPMTest.xcframework.zip" "SPMTest.xcframework"

      - name: ðŸ“Š Compute checksum
        id: checksum
        run: |
          echo "::set-output name=checksum::$(swift package compute-checksum SPMTest.xcframework.zip)"

      - name: ðŸ›  Set variables
        run: |
          echo "ZIPFILE=SPMTest.xcframework.zip" >> $GITHUB_ENV
          echo "CHECKSUM=${{ steps.checksum.outputs.checksum }}" >> $GITHUB_ENV
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: ðŸ“Œ Create GitHub Release & Upload ZIP
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: ${{ env.ZIPFILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§© Update Package.swift
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${ZIPFILE}"
          sed -i '' "s|URL_PLACEHOLDER|${URL}|g" Package.swift
          sed -i '' "s|CHECKSUM_PLACEHOLDER|${CHECKSUM}|g" Package.swift
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift
          git commit -m "chore: update Package.swift with new binary info for ${TAG}"
          git tag -f "${TAG}"
          git push --force origin "refs/tags/${TAG}"